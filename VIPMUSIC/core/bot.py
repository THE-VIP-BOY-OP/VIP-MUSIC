# Copyright (C) 2024 by THE-VIP-BOY-OP@Github, < https://github.com/THE-VIP-BOY-OP >.
#
# This file is part of < https://github.com/THE-VIP-BOY-OP/VIP-MUSIC > project,
# and is released under the "GNU v3.0 License Agreement".
# Please see < https://github.com/THE-VIP-BOY-OP/VIP-MUSIC/blob/master/LICENSE >
#
# All rights reserved.
#

import uvloop
import asyncio
import importlib
import threading
from flask import Flask
from pyrogram import Client, idle
from pyrogram.enums import ChatMemberStatus
from pyrogram.types import BotCommand, InlineKeyboardButton, InlineKeyboardMarkup

import config
from ..logging import LOGGER

uvloop.install()

app = Flask(__name__)

# Web server for health check
@app.route('/')
def home():
    return "Bot is running!"

def run():
    app.run(host="0.0.0.0", port=8000)

class VIPBot(Client):
    def __init__(self):
        LOGGER(__name__).info("Starting Bot")
        super().__init__(
            "VIPMUSIC",
            api_id=config.API_ID,
            api_hash=config.API_HASH,
            bot_token=config.BOT_TOKEN,
        )

    async def start(self):
        await super().start()
        get_me = await self.get_me()
        self.username = get_me.username
        self.id = get_me.id
        self.name = get_me.first_name + " " + (get_me.last_name or "")
        self.mention = get_me.mention

        # Create the button
        button = InlineKeyboardMarkup(
            [
                [
                    InlineKeyboardButton(
                        text="à¹ á´€á´…á´… á´á´‡ ÉªÉ´ É¢Ê€á´á´œá´˜ à¹",
                        url=f"https://t.me/{self.username}?startgroup=true",
                    )
                ]
            ]
        )

        # Try to send a message to the logger group
        if config.LOG_GROUP_ID:
            try:
                await self.send_photo(
                    config.LOG_GROUP_ID,
                    photo=config.START_IMG_URL,
                    caption=f"â•”â•â•â•â•â°ğ–ğ„ğ‹ğ‚ğğŒğ„â±â•â•â•â•ââŠ±âÛªÛª\nâ•‘\nâ•‘â”£âª¼ğŸ¥€ğğ¨ğ­ ğ’ğ­ğšğ«ğ­ğğ ğğšğ›ğ²ğŸ‰\nâ•‘\nâ•‘â”£âª¼ {self.name}\nâ•‘\nâ•‘â”£âª¼ğŸˆğˆğƒ:- `{self.id}` \nâ•‘\nâ•‘â”£âª¼ğŸ„@{self.username} \nâ•‘ \nâ•‘â”£âª¼ğŸ’–ğ“ğ¡ğšğ§ğ¤ğ¬ ğ…ğ¨ğ« ğ”ğ¬ğ¢ğ§ğ ğŸ˜\nâ•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ââŠ±â",
                    reply_markup=button,
                )
            except Exception as e:
                LOGGER(__name__).error(f"Failed to send message in log group: {e}")

        # Setting commands
        if config.SET_CMDS:
            try:
                await self.set_bot_commands(
                    commands=[
                        BotCommand("start", "Start the bot"),
                        BotCommand("help", "Get the help menu"),
                        BotCommand("ping", "Check if the bot is alive or dead"),
                    ],
                    scope="all_private_chats",
                )
                await self.set_bot_commands(
                    commands=[
                        BotCommand("play", "Start playing requested song"),
                        BotCommand("stop", "Stop the current song"),
                        BotCommand("pause", "Pause the current song"),
                        BotCommand("resume", "Resume the paused song"),
                        BotCommand("queue", "Check the queue of songs"),
                    ],
                    scope="all_group_chats",
                )
            except Exception as e:
                LOGGER(__name__).error(f"Failed to set bot commands: {e}")

        LOGGER(__name__).info(f"MusicBot Started as {self.name}")

# Flask app in a separate thread
t = threading.Thread(target=run)
t.start()

# Main event loop to run bot
async def main():
    bot = VIPBot()
    await bot.start()
    await idle()
    await bot.stop()

# Run async event loop
if __name__ == "__main__":
    asyncio.run(main())
